# OpenApi Workshop

## Introduction

Create a new GitHub repository.
Check it out locally and copy this project inside it as inital commit.

### Dependencies

- .NET9 SDK
- node >= v18 (needed for npm packages)

## Instructions - Generate OpenAPI Specification File (Time needed: ???)

Before we can use the OpenAPI specification file we need to create it.
These steps will show you how you can create the file during runtime and as a build artifact.

### Generate the OpenAPI Specification File

There are two relevant packages.
`Microsoft.AspNetCore.OpenApi` builds and serves the `openapi.json` during runtime.
`Microsoft.Extensions.ApiDescription.Server` creates the `openapi.json` during build time so it can be used in the pipelines.
The later one puts the file in the `obj` folder and its named `{ProjectName}.json` by default.

Follow these [steps](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/openapi/aspnetcore-openapi?view=aspnetcore-9.0&tabs=visual-studio%2Cvisual-studio-code#configure-openapi-document-generation) to create the `openapi.json` and serve it during runtime.
Then build and run the API and try to navigate to the specification file to make sure it is actually served.

Then follow these [steps](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/openapi/aspnetcore-openapi?view=aspnetcore-9.0&tabs=visual-studio%2Cvisual-studio-code#generate-openapi-documents-at-build-time) to create the specification file during the build process.

Add the following to the API's `.csproj` file to copy the specification file to the project build output directoy.
Its easier to use it from the pipeline later if we copy it to the output folder.

```XML
<PropertyGroup>
  <OpenApiDocumentsDirectory>$(OutputPath)</OpenApiDocumentsDirectory>
</PropertyGroup>
```

### (Optional) Use the Specification File to show the Swagger UI

TODO: add more details.
Follow these [instructions](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/openapi/using-openapi-documents?view=aspnetcore-9.0#use-swagger-ui-for-local-ad-hoc-testing).

## Instructions - Client Generation (Time needed: ???)

The first thing we are going to do with the new specification file is automatically generate a C# SDK that can be used to call the API.
This workshops covers two options to create it but there are a few more.

### Generate Client SDK using NSwag

Create a new .NET class library project in your solution and call it `Client`.
Delete all the files that are part of the project.
All the files needed for the client will be automatically generated by NSwag.
Next install NSwag as global npm package using `npm install -g nswag`.
You can check out the NSwag CLI documentation [here](https://github.com/RicoSuter/NSwag/wiki/CommandLine).
Because we want to generate C# Client we need to use the `openapi2csclient` command.
We need to specify at least two parameters.
The first is `/input` to specifiy which OpenApi Specification file we want to generate a client for.
The next one is `/output` to specifiy where the generated file should be created.
It is highly recommended to also specify the `/classname` and `/namespace` parameters, as the default naming of the class and the namespace are not very good.

The complete command should look something like this:

```shell
nswag openapi2csclient /input:<pathToYourSpecificationFile>/ProjectManagerSimulatorApi.json /output:<PathToYouClientProject>/Client.cs /namespace:ProjectManagerSimulatorClient  /classname:ProjectManagerSimulatorClient
```

After running the command you should have the generated code in your project.
Make sure to not check the code into git.
Either by being very careful or by just adding the file to your `.gitignore`.
We don't want the generated code to be checked into git as we will dynamically create it using a github action later.
Try to build the client project.
You will see that it will fail complaining about missing dependencies.
Thats because the generated code has a dependency to a nuget package that has not been added to the project file.
So add the `Newtonsoft.Json` package as dependecy.
Try to build the project again and it should compile sucessfully now.

### Publish Client SDK as nuget package using GitHub Actions

As next step we want to publish the Client SDK as nuget package using [GitHub packages](https://docs.github.com/en/packages/learn-github-packages/introduction-to-github-packages).
This makes it easy for other applications to consume the SDK and therefore to call your API.
In general the pipeline needs to go through the following steps:

1. Build the API to generate the OpenAPI specification file
2. Generate the Client SDK code
3. Build the Client SDK
4. Pack the build artifacts into a nuget package
5. Publish the package to the GitHub package feed

Steps 1-3 are basically what you have done locally already.
You just need to convert it to a GitHub Action.
This [documentation about the GitHub Packages Nuget Feed](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-nuget-registry#publishing-a-package) in combination with the [Microsoft Documentation on how to publish Nuget Packages](https://learn.microsoft.com/en-us/nuget/quickstart/create-and-publish-a-package-using-the-dotnet-cli) should give you an idea on how to achieve steps 4 and 5.
You can also try to publish the package locally first, but you will need a [GitHub Personal Access Token (PAT)](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens) to authenticate the request.
Please be aware that you need to select the `classic` PAT when creating it because GitHub packages is not yet compatible with the newer version of PATs.
If you do try this make sure the PAT has the `package write` permission configured.

<details>
<summary> If you are unsure with how the Action file should look like click here for spoilers </summary>

```yml
name: Publish Client NuGet Package

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Build API
        run: dotnet build ProjectManagerSimulatorApi/ProjectManagerSimulatorApi.csproj --configuration Release -o ./ApiOutput

      - uses: actions/setup-node@v4
        name: install node

      - name: install NSwag
        run: npm install -g nswag

      - name: Generate Client
        run: nswag openapi2csclient /input:./ApiOutput/ProjectManagerSimulatorApi.json /output:./Client/Client.cs /namespace:ProjectManagerSimulatorClient  /classname:ProjectManagerSimulatorClient /generateOptionalParameters:true
      
      - name: Pack
        run: dotnet pack Client/Client.csproj --configuration Release --output ./nupkg --version-suffix "alpha"

      - name: Publish to GitHub Packages
        run: dotnet nuget push ./nupkg/*.nupkg --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" --api-key ${{ secrets.GITHUB_TOKEN }}
```


</details>

Be aware that the nuget feed will be connected to your GitHub User and not directly to the project.
You can link it to the project manually.
On your GitHub user profile you should see a `Packages` tab.
There you can configure the settings for the package.

### (optional) Generate Client SDK using Kiota

TODO: Create a new csproj for the Kiota Client and basically do the same as with NSwag but use the Kiota CLI instead of the NSwag CLI.

### (optional) Publish Kiota Client SDK as nuget package using GitHub Actions

TODO: Basically do the same as with the NSwag Client

### Use private Nuget Package to write simple Client

If you have not already done so create a [GitHub Personal Access Token (PAT)](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens) to authenticate the request.
Please be aware that you need to select the `classic` PAT when creating it because GitHub packages is not yet compatible with the newer version of PATs.
This PAT will be used to authenticate you Visual Studio against the private NugetFeed.
To see how you can consume the newly created package create a new Console Application project in your Solution.
To add the private feed open the projects NuGet Manager in VS.
On the top right click on the Gear icon.
There you can a new feed.
After creating it VS will prompt you for your credentials.
Do NOT use your GitHub password.
You need to use the PAT you created.
As Username just use your GitHub username.
After the authentication process you should be able to see and install your nuget package.
Now you can use the SDK from the nuget package to actually call your API with only a few simple lines of code.
To try it I recommend running your API locally by using
`dotnet run` inside the API project directory.
This way you can just use VS as usual to start and debug your client application.

## Instructions - Documentation Generation (Time needed: ???)

### Use Spectral for a quick Documentation

### Setup Simple Docusaurus Documentation

### Use OpenAPI Plugin to use Docusaurus for API Documentation

### Publish the Docusaurus Documentation using GitHub Pages

## Outlook
